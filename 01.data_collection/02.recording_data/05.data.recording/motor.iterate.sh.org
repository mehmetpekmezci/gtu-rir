#!/bin/bash

if [ $# -lt 2 ]
then
    echo "Usage: $0 <T500/T825> <1/0>"
    exit 1
fi


DEVICE=$(ticcmd --list|grep $1| cut -d, -f1)

if [ "$DEVICE" == "" ]
then
    echo "$1 device not found !!"
    exit 1
fi


DIRECTION=$2 ## 1 pozitif, 0 negatif

ITERATION_DURATION=2

VELOCITY=100000

if [ "$DIRECTION" == 0 ]
then
	VELOCITY=-100000
fi


START_POSITION=$(ticcmd -d $DEVICE -s --full| grep position| grep -i current | cut -d: -f2 | awk '{print $1}')

TARGET_END_POSITION=$((START_POSITION+20))

if [ "$DIRECTION" == 0 ]
then
     TARGET_END_POSITION=$((START_POSITION-20))
fi


ticcmd -d $DEVICE --resume --exit-safe-start --velocity $VELOCITY  &
sleep $ITERATION_DURATION
ticcmd -d $DEVICE --halt-and-hold

CURRENT_POSITION=$(ticcmd -d $DEVICE -s --full| grep position| grep -i current | cut -d: -f2 | awk '{print $1}')

echo "CURRENT_POSITION=$CURRENT_POSITION"
echo "TARGET_END_POSITION=$TARGET_END_POSITION"

if [ "$DIRECTION" == 1 -a "$CURRENT_POSITION" -lt "$TARGET_END_POSITION" ]
then
     DIFF=$((TARGET_END_POSITION-CURRENT_POSITION))
     VELOCITY=$((DIFF*10000))
     ticcmd -d $DEVICE --resume --exit-safe-start --velocity $VELOCITY  &
     sleep 1
     ticcmd -d $DEVICE --halt-and-hold

elif [ "$DIRECTION" == 0 -a "$CURRENT_POSITION" -gt "$TARGET_END_POSITION" ]
then
     DIFF=$((CURRENT_POSITION-TARGET_END_POSITION))
     VELOCITY=$((DIFF*-10000))
     ticcmd -d $DEVICE --resume --exit-safe-start --velocity $VELOCITY  &
     sleep 1
     ticcmd -d $DEVICE --halt-and-hold
fi



